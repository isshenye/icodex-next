<!doctype html>
<html class="docs-version-current" lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="icodex RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="icodex Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-153188913-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-153188913-1",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="icodex" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">事件循环 | icodex</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://icodex.me/docs/javascript/Runtime/事件循环"><meta data-react-helmet="true" name="docsearch:language" content="zh-CN"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" name="keywords" content="frontend, react, javascript, css, react, vue, typescript, docusaurus, blog, personal blog, personal website"><meta data-react-helmet="true" property="og:title" content="事件循环 | icodex"><meta data-react-helmet="true" name="description" content="事件循环和任务队列"><meta data-react-helmet="true" property="og:description" content="事件循环和任务队列"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://icodex.me/docs/javascript/Runtime/事件循环"><link data-react-helmet="true" rel="alternate" href="https://icodex.me/docs/javascript/Runtime/事件循环" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://icodex.me/docs/javascript/Runtime/事件循环" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://GMKEEJO8X4-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.83facce5.css">
<link rel="preload" href="/assets/js/runtime~main.bc1968d0.js" as="script">
<link rel="preload" href="/assets/js/main.84a75bf0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="icodex" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.png" alt="icodex" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">icodex</b></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a class="navbar__item navbar__link" href="/pages/project">My Project</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Skill</a><ul class="dropdown__menu"><li><a class="dropdown__link navbar__link--active" href="/docs/javascript/类型/类型定义">JavaScript</a></li><li><a class="dropdown__link" href="/docs/css/CSS代码规范">CSS</a></li><li><a class="dropdown__link" href="/docs/typescript/tsconfig">TypeScript</a></li><li><a class="dropdown__link" href="/docs/react/hooks/常用hooks">React</a></li><li><a class="dropdown__link" href="/docs/nodejs/awesome-nodejs">NodeJS</a></li><li><a class="dropdown__link" href="/docs/engineer/">Engineer</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/network/网速与带宽">Network</a></li><li><a class="dropdown__link" href="/docs/algorithm/算法分析">Algorithm</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/tools/git">Tool</a><a href="https://github.com/wood3n/icodex-next" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0 sidebarWithHideableNavbar_VlPv"><a tabindex="-1" class="sidebarLogo_hmkv" href="/"><img src="/img/logo.png" alt="icodex" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.png" alt="icodex" class="themedImage_TMUO themedImage--dark_uzRr"><b>icodex</b></a><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/DOM/MutationObserver">DOM</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/Date/Date类型">Date</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/Number/Number类型">Number</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/Object/JS 里的面向对象">Object</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/RegExp/RegExp类型">RegExp</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/javascript/Runtime/JS的内存管理">Runtime</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/javascript/Runtime/JS的内存管理">JS内存管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/javascript/Runtime/JS的执行过程">JS执行过程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/javascript/Runtime/this这个东西">this这个东西</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/javascript/Runtime/事件循环">事件循环</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/javascript/Runtime/作用域">作用域</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/javascript/Runtime/闭包">闭包</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/String/String类型">String</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/函数/Function类型">函数</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/性能优化/定时器机制">性能优化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/javascript/类型/操作符类型转换">类型</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>事件循环</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="事件循环和任务队列">事件循环和任务队列<a class="hash-link" href="#事件循环和任务队列" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="什么是事件循环">什么是事件循环<a class="hash-link" href="#什么是事件循环" title="Direct link to heading">​</a></h3><blockquote><p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loops" target="_blank" rel="noopener noreferrer">whatwg - Event loops</a></p></blockquote><p>从 whatwg 的定义来看，<strong>用户代理必须使用事件循环来协调事件（event），用户交互（user interaction），脚本（script），渲染（render），网络请求（network）等任务</strong>。</p><p>这里说的用户代理指的是代表用户行为的软件代理程序，可以是浏览器，也可以是其它客户端程序，例如 Nodejs 等。</p><p>事件循环可以分为以下类型：</p><ul><li>浏览器中同源窗口下的事件循环被称为<strong>window event loop</strong></li><li>在<code>DedicatedWorkerGlobalScope</code>，<code>SharedWorkerGlobalScope</code>，或者<code>ServiceWorkerGlobalScope</code>中的事件循环被称为<strong>worker event loop</strong></li><li>在<code>WorkletGlobalScope</code>中的事件循环被称为<strong>worklet event loop</strong></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="任务队列">任务队列<a class="hash-link" href="#任务队列" title="Direct link to heading">​</a></h3><p>从规范定义的角度来看，每一个事件循环都具有一个或者多个任务队列，任务队列是一系列任务的集合。这里说的任务队列也就是平时所讲的宏观任务的队列。</p><p>需要注意的是任务队列虽然被称为队列，但它只是任务的集合，不是队列的数据结构，因为事件循环处理模型的第一步从选定的队列中获取第一个可运行任务，而不是使队列中的第一个任务出队列，也就是可能取的不是第一个任务。</p><p>任务封装了负责以下工作的算法：</p><ul><li>Events：在特定的<code>EventTarget</code>上分派<code>Event</code>对象，但不是所有的事件对象分配都会封装成任务队列中的任务；</li><li><a href="https://html.spec.whatwg.org/multipage/parsing.html#html-parser" target="_blank" rel="noopener noreferrer">HTML parser</a>解析 HTML，在这个过程中还会遇到<code>&lt;script&gt;</code>加载和解析</li><li><strong>回调函数</strong>；</li><li>使用<code>XMLHttpRequest</code>或者<code>fecth</code>以异步的方式请求网络，在获取响应后，对响应数据的处理将封装成一个任务；</li><li>影响 DOM 操作的元素会产生一些任务，一般是触发事件执行</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="任务来源">任务来源<a class="hash-link" href="#任务来源" title="Direct link to heading">​</a></h3><p>每一个任务都会绑定到指定的任务来源，<strong>任务来源就是用于区分任务类型的</strong>，并且每个任务源都必须与特定的任务队列关联，但是浏览器可能将不同任务来源的任务合并到同一个任务队列中。</p><p>规范定义有以下类型的通用任务来源，如果用户代理在封装一个任务的时候不知道其属于什么任务来源，就会从通用任务来源中选择一种：</p><ul><li>DOM 操作，DOM 操作的过程中会产生任务</li><li>UI 交互，例如鼠标点击，键盘输入等</li><li>响应网络触发的任务，例如<code>XMLHttpRequest</code>，<code>fetch</code>等获取响应的回调</li><li>需要遍历浏览器历史记录的操作，例如<code>history.back()</code>等类似的 API 操作</li></ul><p>除了通用任务来源，来自于其他规范中还定义其它任务来源，常见的还有以下这些任务类型，参见 —— <a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/public/platform/task_type.h;l=68;bpv=0;bpt=1" target="_blank" rel="noopener noreferrer">chromium - task.type</a>：</p><ul><li><code>HTMLCanvasElement.toBlob()</code></li><li>由 JS 发起的<code>setTimeout</code>和<code>setInterval</code>等定时器任务</li><li><code>WebSocket</code></li><li><code>postMessage</code></li><li><code>FileAPI</code>，例如利用<code>Blob</code>或<code>File</code>对象读取文件</li><li><code>WebGL</code></li><li><code>requestAnimationFrame</code></li><li>CSS 字体加载</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="微任务来源">微任务来源<a class="hash-link" href="#微任务来源" title="Direct link to heading">​</a></h3><p>每一个事件循环还具有一个微任务队列，微任务属于在一个任务执行过程中产生的更细粒度的任务，常见的微任务来源：</p><ul><li><p>首先<code>Promise</code>的异步方法是一个微任务，这是在 HTML 规范中明确定义的 —— <a href="https://html.spec.whatwg.org/multipage/webappapis.html#hostenqueuepromisejob" target="_blank" rel="noopener noreferrer">HostEnqueuePromiseJob</a>，这里说的是<code>Promise</code>回调<code>resolve()</code>或者<code>reject()</code>方法，而使用<code>Promise</code>构造函数，内部属于同步的宏任务，会立即执行；</p></li><li><p>利用 DOM 接口<code>MutationObserver</code>创建一个对象并通过<code>observe</code>方法监听 DOM 树的变化；</p></li><li><p>nodejs 中的<code>process.nextTick</code></p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="事件循环处理模型">事件循环处理模型<a class="hash-link" href="#事件循环处理模型" title="Direct link to heading">​</a></h3><blockquote><p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener noreferrer">event-loop-processing-model</a></p></blockquote><p>事件循环处理模型描述的是在事件循环中如何处理任务队列中的任务。</p><p>每一个事件循环中都有一个正在执行的任务（currently running task），一个微任务队列（macro task queue），保存从微任务来源添加进来的微任务（macro task）。</p><p>需要注意的是微任务队列不是任务队列，但是通过事件循环机制<a href="https://html.spec.whatwg.org/multipage/webappapis.html#spin-the-event-loop" target="_blank" rel="noopener noreferrer">spins the event loop</a>，微任务队列中的微任务可能被移动到任务队列中去。</p><p>只要存在事件循环，就必须执行以下步骤：</p><ol><li>首先从事件循环的任务队列中选择一个具有可执行任务（任务所处的当前 DOM 为空或完全处于活动状态）的任务队列；如果在所有的任务队列中都不存在可执行的任务，那么就直接跳到微任务队列执行步骤 7 去；</li><li>让 <code>oldestTask</code>等于当前队列的第一个可执行任务，并将该任务从队列中移除</li><li>设置事件循环的当前执行任务 <code>currently running task</code>等于<code>oldestTask</code></li><li>记录任务开始时间<code>taskStartTime</code></li><li>执行任务</li><li>设置事件循环的当前执行任务 <code>currently running task</code>为<code>null</code></li><li><strong>执行微任务队列检查</strong>，如果存在微任务就将微任务出队列并执行，直到微任务队列为空；</li><li>设置<code>hasARenderingOpportunity</code>为<code>false</code></li><li>设置当前时间<code>now</code></li><li>报告这个任务执行所耗费的时间，这个过程实际上是找出<strong>长任务（long tasks）</strong><ul><li>如果整个任务执行时间小于 <strong>50ms</strong>，就返回去继续执行下面的步骤</li><li>而如果任务执行时间大于 <strong>50ms</strong>，会看作长任务处理</li></ul></li><li>如果当前事件循环是浏览器窗口中的事件循环，则更新 DOM 渲染，此过程会将<code>hasARenderingOpportunity</code>设置为<code>true</code></li><li>满足以下条件时，执行空闲时间算法 —— <a href="https://w3c.github.io/requestidlecallback/#start-an-idle-period-algorithm" target="_blank" rel="noopener noreferrer">start an idle period algorithm</a>：<ul><li>浏览器中的事件循环</li><li>当前页面的事件循环的任务队列中没有任务了</li><li>微任务队列也是空的</li><li><code>hasARenderingOpportunity</code>为<code>false</code></li></ul></li><li>最后一步还会检查 worker event loop 并执行</li></ol><p>从浏览器的角度来看，浏览器在渲染进程的主线程中完成 HTML 解析，CSS 解析，JS 执行等主要任务，并且在网页渲染完成以后，用户操作网页，这个过程可能需要再次调用线程去解析执行 JS 或者渲染网页等。</p><p>举个例子，当在网页中输入表单的时候，渲染进程的 IO 线程需要接收从键盘或者屏幕输入的内容，然后 IO 线程需要将输入内容传递给渲染进程的主线程进行渲染，同时主线程内运行的 JS 还需要根据用户的输入验证输入内容是否合理，主线程既要渲染输入内容，同时还要将输入事件的监听目标通过事件回调传递给 JS，并且 JS 处理完的结果可能涉及到 DOM 更新，又需要调用主线程去渲染。</p><p>首先主线程不知道用户什么时候会去输入内容，所以主线程需要时刻保持开启状态，为了让主线程活跃，在主线程内部引入事件循环机制。然后主线程需要接收任务，这其中包括一些其他线程或者 JS 执行发起的任务，如果一股脑地都塞到主线程内部会引起线程阻塞，那么就需要任务队列来管理这些不同来源的任务，每次主线程执行完一个任务以后，从任务队列头部去取下一个任务，如果有其他任务加入就放到任务队列的尾部等待执行。</p><p><img alt="image-20200820111511012" src="/assets/images/image-20200820111511012-164111427507316-9e91e8ee87b84c73323e07332374d417.png"></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="长任务">长任务<a class="hash-link" href="#长任务" title="Direct link to heading">​</a></h2><p>有待补充</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="ajax">Ajax<a class="hash-link" href="#ajax" title="Direct link to heading">​</a></h2><p>Ajax 全称是 Asynchronous JavaScript + XML，异步 JS 和 xml。Ajax 这个概念最初是一个老外在 2005 年提出的，具体可以从 MDN 的文档中获取相关文章链接 —— <a href="https://pdfs.semanticscholar.org/c440/ae765ff19ddd3deda24a92ac39cef9570f1e.pdf" target="_blank" rel="noopener noreferrer">Ajax: A New Approach to Web Applications</a>。</p><p>根据文章的描述，Ajax 实际上是几种技术的结合：</p><ul><li>使用 HTML 和 CSS 结合的页面；</li><li>使用 DOM 动态展示和交互；</li><li>使用 XML 和 XSLT 进行数据交换和操作；</li><li>使用 XMLHttpRequest 进行异步数据检索；</li><li>最后使用 JS 将上述内容绑定到一起</li></ul><p><img alt="image-20200821114909005" src="/assets/images/image-20200821114909005-164111427507317-f8f4065a72f1833fa7a45922695331d2.png"></p><p>Ajax 经过十几年的发展，到现在也不仅限于使用 XML 的数据格式进行数据交换，更多的是使用<code>JSON</code>格式。并且 Ajax 本身在目前的 web 形态下已经成为了前端异步通信的代名词，引申至包含多个相关的概念，例如<code>Fetch</code>，<code>FileReader</code>等相关使用异步方式获取数据的方法。</p><p>####XMLHttpRequest</p><p>传统的 Ajax 底层便是使用<code>XMLHttpRequest</code>这个方法发起网络请求，从过去使用广泛的 jQuery 中的<code>ajax</code>还是到现在流行的<code>axios</code>也都是对<code>XMLHttpRequest</code>进行的封装。</p><p><code>XMLHttpRequest</code>的原理可以用多进程和任务队列的方式来概括，多进程指的是浏览器的渲染进程在解析网页的过程中遇到<code>XMLHttpRequest</code>发起的请求会交给网络进程去处理；任务队列是指在网络进程从网络中请求到响应数据后，交给渲染进程的时候会被作为一个任务放在任务队列中等待执行。</p><p>建立一个简单的<code>XMLHttpRequest</code>的过程如下：</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> xhr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">xhr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(80, 250, 123)">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">xhr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">open</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">xhr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>首先渲染进程会注册<code>XMLHttpRequest</code>请求对象，并为其设置相应的回调函数；当使用<code>send</code>方法发起网络请求时，渲染进程不会直接发起网络请求，而是将请求发送给网络进程，网络进程会通过调用资源建立 TCP 连接等过程，并发送 HTTP 报文然后获取服务器响应。在网络进程获取响应后，会利用 IPC（进程通信，Inter Process Communication）来通知渲染进程，并把响应结果传递给渲染进程（此过程可能还会进程跨域请求判断的操作），渲染进程在获取到响应数据后，会根据响应数据的类型传递到回调函数中，并封装成任务添加到任务队列中，等待事件循环去执行。</p><p><img alt="image-20200821134854611" src="/assets/images/image-20200821134854611-164111427507318-96343d0b1f09762cd0c4711efa918b06.png"></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="事件循环和-js-执行">事件循环和 JS 执行<a class="hash-link" href="#事件循环和-js-执行" title="Direct link to heading">​</a></h2><p>回到浏览器中来看事件循环，以 Chromium 为例，渲染进程的主线程负责进行 HTML，CSS 的解析，JS 的解析执行等任务，上文说过 HTML 解析会被封装成任务，那么它会放进任务队列中执行，如果遇到<code>&lt;script&gt;</code>就把 JS 的解析执行分别成任务放到任务队列中。</p><p>JS 执行的过程可以用执行上下文栈来处理，创建全局执行上下文，遇到函数，创建函数的执行上下文，但是 JS 可以发起一些“异步”或者延迟执行的任务，例如<code>setTimeout</code>，<code>XMLHttpRequest</code>，<code>Promise</code>等</p><p>有待补充</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="微任务队列">微任务队列<a class="hash-link" href="#微任务队列" title="Direct link to heading">​</a></h2><blockquote><p><a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint" target="_blank" rel="noopener noreferrer">perform a microtask checkpoint</a></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener noreferrer">Promise</a></p></blockquote><p>任务队列中的每一个任务可以称为一个宏任务（macro task），而一个宏任务执行过程中可能由它自身产生一个新的任务，例如 DOM 事件回调，<code>setTimeout</code>延迟回调，<code>XMLHttpRequest</code>请求网络返回结果的回调等；</p><p>一种处理方式是将回调函数的任务直接添加到任务队列尾部，等待事件循环去执行，例如<code>setTimeout</code>和<code>XMLHttpRequest</code>就是利用这种方式；</p><p>如果直接将回调函数添加到任务队列末尾可能会因为等待任务队列中前面待执行的任务而造成延迟，例如<code>setTimeout</code>即使设置的延迟执行时间是 0，它仍然会等到循环执行完才去执行</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">callback</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">callback</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>另一种方式是使用微任务队列（micro task queue）来管理，由微任务队列来保存宏任务执行过程中产生的微任务（micro task），</p><p>当一个宏任务执行完，会执行微任务检查，判断微任务队列中时候存在需要执行的微任务，如果存在就会去执行。所以微任务虽然不会保存在任务队列中，但是它会因为事件循环执行机制被移动到任务队列中去等待执行。</p><p><img alt="image-20200820115444967" src="/assets/images/image-20200820115444967-164111427506715-a4110634104f2445c7cc2eea7c85ba06.png"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/wood3n/icodex-next/tree/master/docs/javascript/Runtime/事件循环.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/javascript/Runtime/this这个东西"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">this这个东西</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/javascript/Runtime/作用域"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">作用域</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#事件循环和任务队列" class="table-of-contents__link toc-highlight">事件循环和任务队列</a><ul><li><a href="#什么是事件循环" class="table-of-contents__link toc-highlight">什么是事件循环</a></li><li><a href="#任务队列" class="table-of-contents__link toc-highlight">任务队列</a></li><li><a href="#任务来源" class="table-of-contents__link toc-highlight">任务来源</a></li><li><a href="#微任务来源" class="table-of-contents__link toc-highlight">微任务来源</a></li><li><a href="#事件循环处理模型" class="table-of-contents__link toc-highlight">事件循环处理模型</a></li></ul></li><li><a href="#长任务" class="table-of-contents__link toc-highlight">长任务</a></li><li><a href="#ajax" class="table-of-contents__link toc-highlight">Ajax</a></li><li><a href="#事件循环和-js-执行" class="table-of-contents__link toc-highlight">事件循环和 JS 执行</a></li><li><a href="#微任务队列" class="table-of-contents__link toc-highlight">微任务队列</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.bc1968d0.js"></script>
<script src="/assets/js/main.84a75bf0.js"></script>
</body>
</html>